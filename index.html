<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>工務室維修管理</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-lg font-bold">工務室維修管理</h1>
    <div>
      <button id="loginBtn" class="bg-white text-blue-600 px-3 py-1 rounded">登入</button>
      <button id="logoutBtn" class="hidden bg-red-500 px-3 py-1 rounded">登出</button>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 p-4 max-w-3xl mx-auto w-full">

    <!-- 分頁 -->
    <div class="flex border-b mb-4 space-x-4">
      <button class="tab-button py-2 px-4 text-blue-600 border-b-2 border-blue-600" data-tab="all">全部</button>
      <button class="tab-button py-2 px-4 text-gray-600 hover:text-blue-600" data-tab="未處理">未處理</button>
      <button class="tab-button py-2 px-4 text-gray-600 hover:text-blue-600" data-tab="處理中">處理中</button>
      <button class="tab-button py-2 px-4 text-gray-600 hover:text-blue-600" data-tab="已完成">已完成</button>
    </div>

    <!-- 排序選項 -->
    <div class="mb-4">
      <label class="mr-2 font-medium">排序：</label>
      <select id="sortOption" class="border rounded px-2 py-1">
        <option value="dateDesc">最新優先</option>
        <option value="dateAsc">最舊優先</option>
        <option value="daysDesc">等待天數最久</option>
        <option value="daysAsc">等待天數最短</option>
      </select>
    </div>

    <!-- 維修表單 (登入後可見) -->
    <form id="issueForm" class="hidden mb-6 bg-white p-4 rounded shadow">
      <h2 class="font-bold mb-2">新增維修項目</h2>
      <input type="text" id="issueInput" placeholder="維修項目" required class="border w-full p-2 mb-2 rounded">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">新增</button>
    </form>

    <!-- 列表 -->
    <div id="issuesList" class="space-y-3"></div>

  </main>

  <script>
    // Firebase 初始化
    const firebaseConfig = {
      apiKey: "你的_API_KEY",
      authDomain: "你的專案.firebaseapp.com",
      projectId: "你的專案",
      storageBucket: "你的專案.appspot.com",
      messagingSenderId: "你的_sender_id",
      appId: "你的_app_id"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const issueForm = document.getElementById("issueForm");
    const issuesList = document.getElementById("issuesList");
    const sortOption = document.getElementById("sortOption");
    const tabButtons = document.querySelectorAll(".tab-button");

    let currentUser = null;
    let currentIssues = [];
    let activeTab = "all";

    // 登入 / 登出
    loginBtn.addEventListener("click", async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    });
    logoutBtn.addEventListener("click", async () => {
      await auth.signOut();
    });

    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        issueForm.classList.remove("hidden");
      } else {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        issueForm.classList.add("hidden");
      }
    });

    // Firestore 即時更新
    db.collection("issues").orderBy("datePosted", "desc").onSnapshot(snapshot => {
      currentIssues = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
      renderIssues(currentIssues);
    });

    // 新增維修項目
    issueForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("請先登入再新增！");
        return;
      }
      const issueName = document.getElementById("issueInput").value.trim();
      if (!issueName) return;
      await db.collection("issues").add({
        issueName,
        status: "未處理",
        datePosted: firebase.firestore.FieldValue.serverTimestamp(),
        vendorReply: "",
        estRepairTime: "",
        createdBy: currentUser.email
      });
      issueForm.reset();
    });

    // 分頁切換
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        activeTab = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove("text-blue-600","border-blue-600","border-b-2"));
        btn.classList.add("text-blue-600","border-blue-600","border-b-2");
        renderIssues(currentIssues);
      });
    });

    // 排序
    sortOption.addEventListener("change", () => renderIssues(currentIssues));

    // 渲染列表
    function renderIssues(issues) {
      issuesList.innerHTML = "";

      // 過濾分頁
      let filtered = issues.filter(issue => {
        if (activeTab === "all") return true;
        return issue.data.status === activeTab;
      });

      // 排序
      const opt = sortOption.value;
      filtered.sort((a,b) => {
        const dateA = a.data.datePosted?.toMillis?.() || 0;
        const dateB = b.data.datePosted?.toMillis?.() || 0;
        const daysA = calcDays(a.data.datePosted);
        const daysB = calcDays(b.data.datePosted);

        if (opt === "dateDesc") return dateB - dateA;
        if (opt === "dateAsc") return dateA - dateB;
        if (opt === "daysDesc") return daysB - daysA;
        if (opt === "daysAsc") return daysA - daysB;
      });

      // 渲染
      filtered.forEach(issue => {
        issuesList.appendChild(createIssueElement(issue));
      });
    }

    // 建立項目 DOM
    function createIssueElement(issue) {
      const data = issue.data;
      const waitingDays = calcDays(data.datePosted);

      let statusColor = "bg-gray-100 text-gray-600";
      if (data.status === "未處理") statusColor = "bg-red-100 text-red-600";
      if (data.status === "處理中") statusColor = "bg-yellow-100 text-yellow-600";
      if (data.status === "已完成") statusColor = "bg-green-100 text-green-600";

      const div = document.createElement("div");
      div.className = "border rounded p-3 shadow-sm bg-white";

      div.innerHTML = `
        <div class="flex justify-between items-center mb-1">
          <h5 class="font-semibold">${data.issueName}</h5>
          <span class="status-label px-2 py-1 text-sm rounded cursor-pointer ${statusColor}" data-id="${issue.id}">
            ${data.status}
          </span>
        </div>
        <p class="text-sm text-gray-600">等待天數：${waitingDays} 天</p>
        <p class="text-sm text-gray-600">預計維修時間：${data.estRepairTime || "-"}</p>
        <p class="text-sm text-gray-600">廠商回覆：${data.vendorReply || "-"}</p>
      `;

      // 綁定狀態點擊事件
      const statusLabel = div.querySelector(".status-label");
      statusLabel.addEventListener("click", async () => {
        if (!currentUser) {
          alert("請先登入才能修改狀態！");
          return;
        }
        const newStatus = getNextStatus(data.status);
        await db.collection("issues").doc(issue.id).update({
          status: newStatus,
          updatedBy: currentUser.email,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });

      return div;
    }

    // 狀態切換順序
    function getNextStatus(current) {
      if (current === "未處理") return "處理中";
      if (current === "處理中") return "已完成";
      return "未處理";
    }

    // 計算等待天數
    function calcDays(date) {
      if (!date) return 0;
      const posted = date.toDate();
      const now = new Date();
      return Math.floor((now - posted) / (1000 * 60 * 60 * 24));
    }
  </script>
</body>
</html>
